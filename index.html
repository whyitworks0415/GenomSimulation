<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ ì „ ì‹œë®¬ë ˆì´ì…˜ (ë² íƒ€ë²„ì „)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* "ëŒ€ì¶© ë§Œë“ " ëŠë‚Œì„ ìœ„í•œ íˆ¬ë°•í•œ ìŠ¤íƒ€ì¼ */
        body {
            font-family: "Gulim", "Malgun Gothic", sans-serif;
            /* êµ´ë¦¼ì²´ ê°ì„± */
            background-color: #cccccc;
            /* ìœˆë„ìš° 95 ë°°ê²½ìƒ‰ ëŠë‚Œ */
            color: black;
        }

        /* ìŠ¤í¬ë¡¤ë°”ë„ íˆ¬ë°•í•˜ê²Œ */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border: 1px solid black;
        }

        ::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border: 1px solid black;
        }

        /* ê°€ê³„ë„ íŠ¸ë¦¬ CSS - ì„ ì„ êµµê³  ê²€ê²Œ */
        .tree {
            display: flex;
            justify-content: center;
            padding-top: 40px;
            width: max-content;
            min-width: 100%;
        }

        .tree ul {
            padding-top: 20px;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .tree li {
            float: left;
            text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 2px 0 2px;
            /* ê°„ê²© ì¢í˜ */
        }

        /* ì»¤ë„¥í„° ì„  (ì§ê°, ê²€ì€ìƒ‰ ì‹¤ì„ ) */
        .tree li::before,
        .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            right: 50%;
            border-top: 2px solid black;
            width: 50%;
            height: 20px;
        }

        .tree li::after {
            right: auto;
            left: 50%;
            border-left: 2px solid black;
        }

        .tree li:only-child::after,
        .tree li:only-child::before {
            display: none;
        }

        .tree li:only-child {
            padding-top: 0;
        }

        .tree li:first-child::before,
        .tree li:last-child::after {
            border: 0 none;
        }

        .tree li:last-child::before {
            border-right: 2px solid black;
            border-radius: 0;
        }

        .tree li:first-child::after {
            border-radius: 0;
        }

        .tree ul ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 2px solid black;
            width: 0;
            height: 20px;
        }

        /* ì‹¬ë³¼ ìŠ¤íƒ€ì¼ - êµµì€ í…Œë‘ë¦¬ */
        .symbol-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
            z-index: 10;
        }

        .symbol-box:hover .pedigree-symbol {
            background-color: yellow;
        }

        /* í˜¸ë²„ì‹œ ë…¸ë€ìƒ‰ */

        .pedigree-symbol {
            width: 20px;
            height: 20px;
            border: 2px solid black;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .male {
            border-radius: 0;
        }

        .female {
            border-radius: 50%;
        }

        /* ì´ìƒ ê°œì²´: ë¹¨ê°„ ë¹—ê¸ˆ ëŠë‚Œ ëŒ€ì‹  ê·¸ëƒ¥ ë¹¨ê°„ìƒ‰ ì¹ í•˜ê¸° */
        .abnormal {
            background-color: #ffcccc;
            border-color: red;
        }

        .spouse-line {
            width: 15px;
            height: 2px;
            background-color: black;
            margin: 0 2px;
            align-self: center;
            position: relative;
            top: -10px;
        }

        .modal {
            display: none;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .modal.active {
            display: flex;
        }

        /* íˆ¬ë°•í•œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ */
        .btn-retro {
            border: 2px solid black;
            background-color: #e0e0e0;
            padding: 4px 8px;
            font-weight: bold;
            box-shadow: 2px 2px 0px 0px black;
            transition: all 0.1s;
        }

        .btn-retro:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* íˆ¬ë°•í•œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .box-retro {
            border: 2px solid black;
            background: white;
            padding: 10px;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- í—¤ë”: ê·¸ëƒ¥ ê²€ì€ ì¤„ -->
    <header class="bg-black text-white p-2 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <h1 class="text-lg font-bold">ğŸ§¬ ìœ ì „ ì‹œë®¬ë ˆì´í„° v2.0 (ë¬´í•œ ì„¸ëŒ€)</h1>
        </div>
        <div class="text-xs">
            ì œì‘: í•™ìƒìš© / ê³¼ì œìš©
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">

        <!-- ì™¼ìª½ íŒ¨ë„: ì»¨íŠ¸ë¡¤ -->
        <aside class="w-72 bg-[#dddddd] border-r-2 border-black flex flex-col shrink-0 overflow-y-auto">
            <div class="p-3 space-y-4">

                <!-- 1. ìœ ì „ì ì„¤ì • -->
                <section class="box-retro">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-bold">ì—¼ìƒ‰ì²´(ìœ ì „ì) ëª©ë¡</label>
                        <button onclick="addGene()" class="btn-retro text-xs">
                            + ì¶”ê°€
                        </button>
                    </div>
                    <div id="geneList" class="space-y-2"></div>
                </section>

                <!-- 2. Pì„¸ëŒ€ ì„¤ì • -->
                <section class="box-retro">
                    <h2 class="font-bold mb-2 border-b-2 border-black pb-1">ë¶€ëª¨ ìœ ì „ìí˜• ì„¤ì •</h2>
                    <div class="space-y-2">
                        <div class="border border-black p-1 bg-[#eeeeee]">
                            <div class="font-bold text-center text-sm mb-1">[ ì•„ë¹  (XY) ]</div>
                            <div id="parent1-genotypes" class="space-y-1"></div>
                        </div>
                        <div class="border border-black p-1 bg-[#eeeeee]">
                            <div class="font-bold text-center text-sm mb-1">[ ì—„ë§ˆ (XX) ]</div>
                            <div id="parent2-genotypes" class="space-y-1"></div>
                        </div>
                    </div>
                </section>

                <!-- 3. í™˜ê²½ ì„¤ì • -->
                <section class="box-retro">
                    <h2 class="font-bold mb-2 border-b-2 border-black pb-1">ì‹¤í—˜ ë³€ìˆ˜</h2>

                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span>ìì† ìˆ˜ ì„¤ì • (ì œí•œ ì—†ìŒ)</span>
                        </div>
                        <!-- ìì† ìˆ˜ ì…ë ¥ë°©ì‹ ë³€ê²½: ì œí•œ ì—†ëŠ” Number Input -->
                        <input type="number" id="offspringCount" value="20" min="1"
                            class="w-full border-2 border-black p-1 text-sm bg-white" placeholder="ìˆ«ì ì…ë ¥">
                        <div class="text-[10px] text-gray-600 mt-1">* ë„ˆë¬´ í° ìˆ˜ëŠ” ë ‰ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ</div>
                    </div>

                    <div class="bg-white border border-black p-2">
                        <h3 class="text-xs font-bold text-red-600 mb-2">
                            ! ë¹„ë¶„ë¦¬ í™•ë¥  (ëŒì—°ë³€ì´)
                        </h3>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs block">ê°ìˆ˜ 1ë¶„ì—´ (%)</label>
                                <input type="number" id="m1Prob" value="0" min="0" max="50"
                                    class="w-full border-2 border-black px-1 text-sm">
                            </div>
                            <div>
                                <label class="text-xs block">ê°ìˆ˜ 2ë¶„ì—´ (%)</label>
                                <input type="number" id="m2Prob" value="0" min="0" max="50"
                                    class="w-full border-2 border-black px-1 text-sm">
                            </div>
                        </div>
                    </div>
                </section>

                <button onclick="runSimulation()" class="btn-retro w-full py-2 bg-blue-200">
                    â–¶ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ (F1 ìƒì„±)
                </button>
            </div>
        </aside>

        <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ê²°ê³¼ -->
        <main class="flex-1 bg-white flex flex-col h-full overflow-hidden relative">

            <!-- íƒ­ ë©”ë‰´: í´ë” íƒ­ ëŠë‚Œ -->
            <div class="bg-[#cccccc] border-b-2 border-black px-2 flex gap-1 shrink-0 pt-2">
                <button onclick="switchTab('pedigree')" id="tab-pedigree"
                    class="px-4 py-1 border-t-2 border-x-2 border-black bg-white font-bold text-sm relative top-[2px] z-10">
                    ê°€ê³„ë„ ë³´ê¸°
                </button>
                <button onclick="switchTab('stats')" id="tab-stats"
                    class="px-4 py-1 border-t-2 border-x-2 border-black bg-[#aaaaaa] text-white text-sm relative top-[2px]">
                    ê²°ê³¼ ë¦¬í¬íŠ¸
                </button>
            </div>

            <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
            <div class="flex-1 overflow-auto p-4" id="mainContentArea">

                <!-- ì´ˆê¸° ì•ˆë‚´ -->
                <div id="initialState" class="h-full flex flex-col items-center justify-center text-gray-500">
                    <div class="border-2 border-black p-4 text-center bg-[#eeeeee]">
                        <h3 class="font-bold text-black mb-2">ì‹¤í—˜ ì¤€ë¹„ ìƒíƒœ</h3>
                        <p class="text-sm">ì™¼ìª½ì—ì„œ ì„¤ì • í›„ [ì‹¤í–‰] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                    </div>
                </div>

                <!-- 1. ê°€ê³„ë„ ë·° -->
                <div id="view-pedigree" class="hidden min-w-full min-h-full pb-20">
                    <div class="tree">
                        <ul>
                            <li>
                                <!-- P ì„¸ëŒ€ (ë¶€ëª¨) -->
                                <div class="flex items-center justify-center gap-0 mb-6">
                                    <div class="symbol-box" onclick="showParentDetail('p1')">
                                        <div class="pedigree-symbol male"></div>
                                        <div class="text-xs font-bold mt-1">ì•„ë¹ </div>
                                    </div>

                                    <div class="w-10 h-[2px] bg-black relative top-[-10px]"></div>
                                    <!-- Marriage Line -->

                                    <div class="symbol-box" onclick="showParentDetail('p2')">
                                        <div class="pedigree-symbol female"></div>
                                        <div class="text-xs font-bold mt-1">ì—„ë§ˆ</div>
                                    </div>
                                </div>

                                <!-- F1 ìì‹ë“¤ (ì¬ê·€ì  íŠ¸ë¦¬ ì‹œì‘ì ) -->
                                <ul id="f1-tree-container">
                                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„±ë¨ -->
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- 2. í†µê³„ ë·° -->
                <div id="view-stats" class="hidden space-y-4 max-w-4xl mx-auto">
                    <div class="bg-yellow-100 border border-black p-2 text-xs mb-2">
                        * í†µê³„ëŠ” í˜„ì¬ ìƒì„±ëœ ëª¨ë“  ìì†(F1, F2...)ì„ í¬í•¨í•©ë‹ˆë‹¤.
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- ëŒì—°ë³€ì´ ì°¨íŠ¸ -->
                        <div class="box-retro">
                            <h3 class="font-bold text-sm border-b-2 border-black mb-2">1. í•µí˜• ë¶„ì„ (ì •ìƒ vs ë¹„ë¶„ë¦¬)</h3>
                            <div class="h-48 relative">
                                <canvas id="mutationChart"></canvas>
                            </div>
                            <div id="mutationSummary" class="mt-2 text-xs border-t border-black pt-2"></div>
                        </div>

                        <!-- ë‹¨ì¼ ì¸ì ì°¨íŠ¸ -->
                        <div class="box-retro">
                            <h3 class="font-bold text-sm border-b-2 border-black mb-2">2. ë‹¨ì¼ ì¸ì ë¶„ë¦¬ë¹„</h3>
                            <div class="h-48 relative">
                                <canvas id="singleGeneChart"></canvas>
                            </div>
                        </div>

                        <!-- ë‹¤ì¸ì ì°¨íŠ¸ -->
                        <div class="box-retro col-span-1 md:col-span-2">
                            <h3 class="font-bold text-sm border-b-2 border-black mb-2">3. ë‹¤ì¸ì ìœ ì „ ë¶„í¬ (ì •ê·œë¶„í¬)</h3>
                            <div id="polyChartArea"
                                class="h-64 flex items-center justify-center text-sm bg-gray-100 border border-gray-300">
                                ë‹¤ì¸ì ìœ ì „ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ë²”ë¡€ (í™”ë©´ ìš°ì¸¡ í•˜ë‹¨ ê³ ì •) -->
            <div class="absolute bottom-4 right-4 box-retro text-xs z-30 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                <div class="font-bold mb-1 border-b border-black">ë²”ë¡€</div>
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-3 h-3 border border-black bg-white"></div> ë‚¨ì„± (XY)
                </div>
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-3 h-3 border border-black rounded-full bg-white"></div> ì—¬ì„± (XX)
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 border border-red-600 bg-[#ffcccc]"></div> ë¹„ë¶„ë¦¬(ì´ìƒ)
                </div>
            </div>

        </main>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="detailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white border-2 border-black p-1 w-full max-w-md shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
            <!-- íŒì—… í—¤ë” -->
            <div class="bg-blue-800 text-white px-2 py-1 flex justify-between items-center mb-4">
                <span class="font-bold text-sm">ê°œì²´ ìƒì„¸ ì •ë³´</span>
                <button onclick="closeModal()" class="text-white hover:bg-red-600 px-1">X</button>
            </div>

            <div class="px-4 pb-4">
                <div class="flex items-start gap-4 mb-4 border-b-2 border-black pb-4">
                    <div id="modalSymbol"
                        class="w-16 h-16 border-2 border-black flex items-center justify-center shrink-0 bg-white text-2xl font-bold">
                        <!-- Symbol -->
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">ID: <span id="modalId"></span></div>
                        <div class="font-bold text-lg" id="modalGenderText"></div>
                        <span id="modalGenerationBadge" class="bg-black text-white text-xs px-1">F1</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <!-- ê²½ê³ ì°½ -->
                    <div id="modalAbnormality"
                        class="hidden border-2 border-red-600 bg-red-100 p-2 text-red-600 font-bold text-xs text-center">
                        !!! ì—¼ìƒ‰ì²´ ìˆ˜ ì´ìƒ ë°œê²¬ !!!<br>
                        <span id="modalAbnormalText" class="font-normal text-black"></span>
                    </div>

                    <div class="border border-black p-2 bg-gray-100">
                        <div class="text-xs font-bold mb-1">ìœ ì „ìí˜•:</div>
                        <div id="modalGenotype" class="font-mono text-sm"></div>
                    </div>

                    <div id="polyInfoBox" class="hidden border border-black p-2 bg-gray-100 flex justify-between">
                        <span class="text-xs font-bold">ëŒ€ë¬¸ì ìœ ì „ì ìˆ˜:</span>
                        <span id="modalCapitalCount" class="font-bold"></span>
                    </div>
                </div>

                <!-- ë‹¤ìŒ ì„¸ëŒ€ ìƒì„± ì„¹ì…˜ (ëª¨ë“  ì„¸ëŒ€ì—ì„œ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½) -->
                <div id="nextGenCreationSection" class="mt-4 pt-4 border-t-2 border-dashed border-gray-400">
                    <h4 class="font-bold text-sm mb-2">> ë‹¤ìŒ ì„¸ëŒ€(<span id="nextGenLabel">F?</span>) ë§Œë“¤ê¸°</h4>
                    <div class="bg-gray-200 border border-black p-2">
                        <div class="text-xs mb-1">ë°°ìš°ì ìœ ì „ìí˜• ì„ íƒ:</div>
                        <div id="spouseGeneSettings" class="grid grid-cols-2 gap-2 mb-2 max-h-32 overflow-y-auto"></div>

                        <div class="flex flex-col gap-2 mt-2">
                            <div class="text-xs flex items-center justify-between">
                                <span>ìì† ìˆ˜:</span>
                                <input type="number" id="nextGenCount" value="4" min="1"
                                    class="w-16 border border-black text-center">
                            </div>
                            <button onclick="generateNextGen()" class="btn-retro bg-white text-xs w-full py-1">
                                ê²°í˜¼ ë° ì¶œì‚° ì‹¤í–‰
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ---
        const GENE_LABELS = ['A', 'B', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

        // ë°ì´í„° êµ¬ì¡° ë³€ê²½: ë¬´í•œ ì„¸ëŒ€ë¥¼ ìœ„í•´ 
        let state = {
            genes: [{ id: 'A', type: 'single' }, { id: 'B', type: 'single' }],
            parents: { p1: {}, p2: {} },
            f1: [],       // Root ìì† (F1)
            descendants: {}, // Map<ParentID, { spouse: {}, children: [] }> -> ëª¨ë“  ìì† ê´€ë¦¬
            charts: { single: null, poly: null, mutation: null },
            selectedChild: null
        };

        function init() {
            renderGeneList();
            renderParentInputs();
        }

        // --- ìœ ì „ì ì¶”ê°€/ì‚­ì œ ---
        function addGene() {
            if (state.genes.length >= GENE_LABELS.length) return alert("ë” ì´ìƒ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            state.genes.push({ id: GENE_LABELS[state.genes.length], type: 'single' });
            renderGeneList();
            renderParentInputs();
        }

        function removeGene(idx) {
            if (state.genes.length <= 1) return;
            state.genes.splice(idx, 1);
            state.genes = state.genes.map((g, i) => ({ ...g, id: GENE_LABELS[i] }));
            state.parents = { p1: {}, p2: {} };
            renderGeneList();
            renderParentInputs();
        }

        function toggleGeneType(idx) {
            state.genes[idx].type = state.genes[idx].type === 'single' ? 'poly' : 'single';
            renderGeneList();
        }

        // --- ë Œë”ë§: ìœ ì „ì ëª©ë¡ ---
        function renderGeneList() {
            const list = document.getElementById('geneList');
            list.innerHTML = '';
            state.genes.forEach((g, i) => {
                list.innerHTML += `
                    <div class="flex items-center justify-between border-b border-gray-400 pb-1 mb-1 text-xs">
                        <div class="flex items-center gap-2">
                            <span class="font-bold bg-black text-white px-1">${g.id}</span>
                            <label class="flex items-center cursor-pointer select-none">
                                <input type="checkbox" ${g.type === 'poly' ? 'checked' : ''} onchange="toggleGeneType(${i})" class="mr-1">
                                ë‹¤ì¸ì ë¬¶ê¸°
                            </label>
                        </div>
                        <button onclick="removeGene(${i})" class="text-red-600 font-bold">[ì‚­ì œ]</button>
                    </div>
                `;
            });
        }

        // --- ë Œë”ë§: ë¶€ëª¨ ìœ ì „ìí˜• ---
        function renderParentInputs() {
            ['p1', 'p2'].forEach(pid => {
                const container = document.getElementById(`parent${pid === 'p1' ? '1' : '2'}-genotypes`);
                container.innerHTML = '';
                state.genes.forEach(g => {
                    const current = state.parents[pid][g.id] || `${g.id}${g.id.toLowerCase()}`;
                    state.parents[pid][g.id] = current;

                    container.innerHTML += `
                        <div class="flex justify-between items-center text-xs border-b border-dashed border-gray-400 py-1">
                            <span class="font-bold w-4">${g.id}</span>
                            <select onchange="state.parents['${pid}']['${g.id}'] = this.value" class="border border-black bg-white px-1 w-full ml-1">
                                <option value="${g.id}${g.id}" ${current === `${g.id}${g.id}` ? 'selected' : ''}>${g.id}${g.id}</option>
                                <option value="${g.id}${g.id.toLowerCase()}" ${current === `${g.id}${g.id.toLowerCase()}` ? 'selected' : ''}>${g.id}${g.id.toLowerCase()}</option>
                                <option value="${g.id.toLowerCase()}${g.id.toLowerCase()}" ${current === `${g.id.toLowerCase()}${g.id.toLowerCase()}` ? 'selected' : ''}>${g.id.toLowerCase()}${g.id.toLowerCase()}</option>
                            </select>
                        </div>
                    `;
                });
            });
        }

        // --- ë¡œì§: ê°ìˆ˜ë¶„ì—´ (ë¹„ë¶„ë¦¬ í¬í•¨) ---
        function meiosis(genotypeStr, m1, m2) {
            let alleles = genotypeStr.split('');
            const rand = Math.random() * 100;

            if (rand < m1) { // 1ë¶„ì—´ ë¹„ë¶„ë¦¬
                return Math.random() < 0.5 ? alleles : [];
            }
            else if (rand < (m1 + m2)) { // 2ë¶„ì—´ ë¹„ë¶„ë¦¬
                const picked = alleles[Math.floor(Math.random() * alleles.length)];
                return Math.random() < 0.5 ? [picked, picked] : [];
            }
            else { // ì •ìƒ
                return [alleles[Math.floor(Math.random() * alleles.length)]];
            }
        }

        function createChild(id, parent1Geno, parent2Geno, m1, m2, generation) {
            const child = {
                id: id,
                gen: generation,
                gender: Math.random() < 0.5 ? 'M' : 'F',
                genes: {},
                isAbnormal: false,
                abnormalDetails: []
            };

            state.genes.forEach(g => {
                const sp = meiosis(parent1Geno[g.id], m1, m2);
                const egg = meiosis(parent2Geno[g.id], m1, m2);
                const zygote = [...sp, ...egg].sort();

                if (zygote.length !== 2) {
                    child.isAbnormal = true;
                    const type = zygote.length > 2 ? '3ì²´(2n+1)' : (zygote.length < 2 ? '0ì²´(2n-2)' : '1ì²´(2n-1)');
                    child.abnormalDetails.push(`${g.id}: ${type}`);
                }
                child.genes[g.id] = zygote;
            });

            return child;
        }

        // --- ì‹¤í–‰ ---
        function runSimulation() {
            // ìˆ«ì ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° (ì œí•œ ì—†ìŒ)
            let count = parseInt(document.getElementById('offspringCount').value);
            if (isNaN(count) || count < 1) count = 20;

            const m1 = parseFloat(document.getElementById('m1Prob').value);
            const m2 = parseFloat(document.getElementById('m2Prob').value);

            state.f1 = [];
            state.descendants = {}; // ì´ˆê¸°í™”

            // F1 ìƒì„±
            for (let i = 0; i < count; i++) {
                state.f1.push(createChild(`F1-${i + 1}`, state.parents.p1, state.parents.p2, m1, m2, 'F1'));
            }

            updateUI();
            switchTab('pedigree');
        }

        // --- ë‹¤ìŒ ì„¸ëŒ€ ìƒì„± (ë¬´í•œ í™•ì¥) ---
        function generateNextGen() {
            const p1 = state.selectedChild;
            if (!p1) return;

            // ë°°ìš°ì ìœ ì „ìí˜•
            const spouseGeno = {};
            state.genes.forEach(g => {
                const select = document.getElementById(`spouse-gene-${g.id}`);
                spouseGeno[g.id] = select.value;
            });

            // ì…ë ¥ê°’ í™•ì¸
            let count = parseInt(document.getElementById('nextGenCount').value);
            if (isNaN(count) || count < 1) count = 4;

            const m1 = parseFloat(document.getElementById('m1Prob').value);
            const m2 = parseFloat(document.getElementById('m2Prob').value);

            // í˜„ì¬ ê°œì²´ì˜ ìœ ì „ìí˜• í¬ë§·íŒ…
            const p1GenoFormatted = {};
            for (const k in p1.genes) p1GenoFormatted[k] = p1.genes[k].join('');

            // ë‹¤ìŒ ì„¸ëŒ€ ë¼ë²¨ ê³„ì‚° (F1 -> F2, F2 -> F3 ...)
            const currentGenNum = parseInt(p1.gen.replace('F', ''));
            const nextGenLabel = `F${currentGenNum + 1}`;

            const children = [];
            for (let i = 0; i < count; i++) {
                children.push(createChild(`${nextGenLabel}-${p1.id}-${i + 1}`, p1GenoFormatted, spouseGeno, m1, m2, nextGenLabel));
            }

            // ìì† ì €ì¥ (Map ì‚¬ìš©)
            state.descendants[p1.id] = { spouse: spouseGeno, children: children };

            closeModal();
            renderPedigree();
            renderStats(); // í†µê³„ ê°±ì‹ 
        }

        // --- ë Œë”ë§: ê°€ê³„ë„ (ì¬ê·€ì ) ---
        function updateUI() {
            document.getElementById('initialState').classList.add('hidden');
            document.getElementById('view-pedigree').classList.remove('hidden');
            renderPedigree();
            renderStats();
        }

        function renderPedigree() {
            const container = document.getElementById('f1-tree-container');
            container.innerHTML = ''; // ì´ˆê¸°í™”

            state.f1.forEach(child => {
                // HTML ë¬¸ìì—´ë¡œ ì¬ê·€ì  íŠ¸ë¦¬ ìƒì„±
                container.innerHTML += buildTreeHtmlRecursive(child);
            });
        }

        function buildTreeHtmlRecursive(person) {
            let html = '<li>';

            let nodeMarkup = createNodeHtml(person);
            const family = state.descendants[person.id];

            if (family) {
                // ìì†ì´ ìˆìœ¼ë©´ ë°°ìš°ìì™€ ì—°ê²°í•˜ì—¬ í‘œì‹œ
                const spouseClass = person.gender === 'M' ? 'female' : 'male';
                nodeMarkup = `
                    <div class="flex items-center justify-center group" style="gap:2px;">
                        ${nodeMarkup}
                        <div class="spouse-line" style="top:-12px;"></div>
                        <div class="symbol-box opacity-75">
                            <div class="pedigree-symbol ${spouseClass} bg-gray-200 border-dashed border-gray-600"></div>
                            <div class="text-[9px] mt-1 text-gray-500">ë°°ìš°ì</div>
                        </div>
                    </div>
                `;

                html += nodeMarkup;

                // ìì‹ë“¤ ì¬ê·€ í˜¸ì¶œ
                html += '<ul>';
                family.children.forEach(child => {
                    html += buildTreeHtmlRecursive(child);
                });
                html += '</ul>';
            } else {
                // ìì† ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë…¸ë“œë§Œ
                html += nodeMarkup;
            }

            html += '</li>';
            return html;
        }

        function createNodeHtml(child) {
            const shapeClass = child.gender === 'M' ? 'male' : 'female';
            const abnormalClass = child.isAbnormal ? 'abnormal' : '';

            // ë°ì´í„° ì†ì„±ì— IDì™€ Gen ì €ì¥ (í´ë¦­ ì´ë²¤íŠ¸ìš©)
            return `
                <div class="symbol-box" onclick="openDetailModal('${child.id}', '${child.gen}')">
                    <div class="pedigree-symbol ${shapeClass} ${abnormalClass}"></div>
                    <div class="text-[9px] mt-1 font-bold whitespace-nowrap">${child.id}</div>
                </div>
            `;
        }

        // --- ì°¨íŠ¸ ë Œë”ë§ (ëª¨ë“  ìì† í¬í•¨í•˜ë„ë¡ ìˆ˜ì •) ---
        function getAllIndividuals() {
            // BFSë‚˜ ì¬ê·€ë¡œ ëª¨ë“  ìì† ìˆ˜ì§‘
            let all = [...state.f1];
            let queue = [...state.f1];

            while (queue.length > 0) {
                const p = queue.shift();
                const fam = state.descendants[p.id];
                if (fam) {
                    all.push(...fam.children);
                    queue.push(...fam.children);
                }
            }
            return all;
        }

        function renderStats() {
            const population = getAllIndividuals();
            if (population.length === 0) return;

            // 1. ëŒì—°ë³€ì´ ì°¨íŠ¸
            const ctxMut = document.getElementById('mutationChart');
            if (state.charts.mutation) state.charts.mutation.destroy();

            let normal = 0, abnormal = 0;
            const anomalyTypes = {};

            population.forEach(c => {
                if (c.isAbnormal) {
                    abnormal++;
                    c.abnormalDetails.forEach(det => {
                        anomalyTypes[det] = (anomalyTypes[det] || 0) + 1;
                    });
                } else {
                    normal++;
                }
            });

            state.charts.mutation = new Chart(ctxMut, {
                type: 'pie',
                data: {
                    labels: ['ì •ìƒ', 'ë¹„ë¶„ë¦¬(ì´ìƒ)'],
                    datasets: [{
                        data: [normal, abnormal],
                        backgroundColor: ['#eeeeee', '#ff9999'],
                        borderColor: 'black',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            document.getElementById('mutationSummary').innerHTML = abnormal > 0
                ? `<span class="text-red-600 font-bold">ë¹„ë¶„ë¦¬ ë°œìƒë¥ : ${((abnormal / population.length) * 100).toFixed(1)}%</span><br>${Object.keys(anomalyTypes).map(k => `- ${k}: ${anomalyTypes[k]}ëª…`).join('<br>')}`
                : "ëª¨ë‘ ì •ìƒì…ë‹ˆë‹¤.";

            // 2. ë‹¨ì¼ ì¸ì
            const target = state.genes.find(g => g.type === 'single') || state.genes[0];
            const ctx1 = document.getElementById('singleGeneChart');
            if (state.charts.single) state.charts.single.destroy();

            let dom = 0, rec = 0;
            population.forEach(c => {
                const arr = c.genes[target.id];
                if (arr.some(a => a === a.toUpperCase())) dom++;
                else rec++;
            });

            state.charts.single = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['ìš°ì„±(_)', 'ì—´ì„±(aa)'],
                    datasets: [{
                        label: 'ê°œì²´ ìˆ˜',
                        data: [dom, rec],
                        backgroundColor: ['black', 'gray'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 3. ë‹¤ì¸ì
            const polyGenes = state.genes.filter(g => g.type === 'poly');
            const polyArea = document.getElementById('polyChartArea');

            if (polyGenes.length > 0) {
                polyArea.innerHTML = '<canvas id="polyGeneChart"></canvas>';
                const ctx2 = document.getElementById('polyGeneChart');

                const counts = {};
                population.forEach(c => {
                    let cap = 0;
                    polyGenes.forEach(g => {
                        c.genes[g.id].forEach(a => { if (a === a.toUpperCase()) cap++; });
                    });
                    counts[cap] = (counts[cap] || 0) + 1;
                });

                const labels = Object.keys(counts).sort((a, b) => Number(a) - Number(b));
                const data = labels.map(k => counts[k]);

                if (state.charts.poly) state.charts.poly.destroy();
                state.charts.poly = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ê°œì²´ ìˆ˜',
                            data: data,
                            borderColor: 'black',
                            backgroundColor: 'rgba(0,0,0,0.1)',
                            fill: true,
                            tension: 0, // ì§ì„ 
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            } else {
                polyArea.innerHTML = 'ë‹¤ì¸ì ìœ ì „ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        // --- ëª¨ë‹¬ ê´€ë ¨ ---
        function openDetailModal(id, gen) {
            // IDë¡œ ê°œì²´ ì°¾ê¸° (ì „ì²´ íƒìƒ‰)
            let child = null;

            // F1ì—ì„œ ê²€ìƒ‰
            child = state.f1.find(c => c.id === id);

            // ì—†ìœ¼ë©´ ìì†ë“¤(descendants)ì—ì„œ ê²€ìƒ‰
            if (!child) {
                // descendants Mapì˜ ëª¨ë“  valuesë¥¼ ìˆœíšŒ
                for (let fam of Object.values(state.descendants)) {
                    child = fam.children.find(c => c.id === id);
                    if (child) break;
                }
            }

            if (!child) return; // ëª» ì°¾ìŒ

            state.selectedChild = child;

            const symDiv = document.getElementById('modalSymbol');
            const isBoy = child.gender === 'M';
            symDiv.className = `w-16 h-16 border-2 border-black flex items-center justify-center shrink-0 bg-white text-3xl font-bold ${isBoy ? '' : 'rounded-full'}`;
            symDiv.innerText = isBoy ? 'â–¡' : 'â—‹';

            document.getElementById('modalId').innerText = id;
            document.getElementById('modalGenerationBadge').innerText = gen;
            document.getElementById('modalGenderText').innerText = isBoy ? 'ë‚¨ì„± (XY)' : 'ì—¬ì„± (XX)';

            const abBox = document.getElementById('modalAbnormality');
            if (child.isAbnormal) {
                abBox.classList.remove('hidden');
                document.getElementById('modalAbnormalText').innerText = child.abnormalDetails.join(', ');
            } else {
                abBox.classList.add('hidden');
            }

            let genoHtml = '';
            let capitals = 0;
            state.genes.forEach(g => {
                const alleles = child.genes[g.id];
                const str = alleles.join('');
                if (g.type === 'poly') {
                    alleles.forEach(a => { if (a === a.toUpperCase()) capitals++; });
                }
                const style = alleles.length !== 2 ? 'text-red-600 font-bold' : '';
                genoHtml += `<span class="mr-3 ${style}">${g.id}:${str || '-'}</span>`;
            });
            document.getElementById('modalGenotype').innerHTML = genoHtml;

            const hasPoly = state.genes.some(g => g.type === 'poly');
            const polyBox = document.getElementById('polyInfoBox');
            if (hasPoly) {
                polyBox.classList.remove('hidden');
                document.getElementById('modalCapitalCount').innerText = capitals;
            } else {
                polyBox.classList.add('hidden');
            }

            // ë‹¤ìŒ ì„¸ëŒ€ ìƒì„± ë¼ë²¨ ì„¤ì •
            const currentGenNum = parseInt(gen.replace('F', ''));
            const nextGenLabel = `F${currentGenNum + 1}`;
            document.getElementById('nextGenLabel').innerText = nextGenLabel;

            // ë°°ìš°ì ì„¤ì • í¼ ìƒì„±
            const spouseForm = document.getElementById('spouseGeneSettings');
            spouseForm.innerHTML = '';
            state.genes.forEach(g => {
                spouseForm.innerHTML += `
                    <div class="flex items-center justify-between border-b border-gray-400 pb-1 text-xs">
                        <span class="font-bold w-4">${g.id}</span>
                        <select id="spouse-gene-${g.id}" class="border border-black px-1">
                            <option value="${g.id}${g.id}">${g.id}${g.id}</option>
                            <option value="${g.id}${g.id.toLowerCase()}" selected>${g.id}${g.id.toLowerCase()}</option>
                            <option value="${g.id.toLowerCase()}${g.id.toLowerCase()}">${g.id.toLowerCase()}${g.id.toLowerCase()}</option>
                        </select>
                    </div>
                `;
            });

            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
            state.selectedChild = null;
        }

        function switchTab(tab) {
            document.getElementById('view-pedigree').classList.add('hidden');
            document.getElementById('view-stats').classList.add('hidden');

            const btnP = document.getElementById('tab-pedigree');
            const btnS = document.getElementById('tab-stats');

            if (tab === 'pedigree') {
                document.getElementById('view-pedigree').classList.remove('hidden');
                btnP.className = "px-4 py-1 border-t-2 border-x-2 border-black bg-white font-bold text-sm relative top-[2px] z-10";
                btnS.className = "px-4 py-1 border-t-2 border-x-2 border-black bg-[#aaaaaa] text-white text-sm relative top-[2px]";
            } else {
                document.getElementById('view-stats').classList.remove('hidden');
                btnS.className = "px-4 py-1 border-t-2 border-x-2 border-black bg-white font-bold text-sm relative top-[2px] z-10";
                btnP.className = "px-4 py-1 border-t-2 border-x-2 border-black bg-[#aaaaaa] text-white text-sm relative top-[2px]";
                // íƒ­ ì „í™˜ ì‹œ ì°¨íŠ¸ ë¦¬ë Œë”ë§ (ìµœì‹  ë°ì´í„° ë°˜ì˜)
                renderStats();
            }
        }

        function showParentDetail(pid) {
            alert(`[ë¶€ëª¨ ì •ë³´ ${pid.toUpperCase()}]\n` +
                state.genes.map(g => `${g.id}: ${state.parents[pid][g.id]}`).join('\n'));
        }

        init();
    </script>
</body>

</html>